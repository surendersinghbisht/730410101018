import express from "express";
import mongoose from "mongoose";
import cors from "cors";
import dotenv from "dotenv";
import { comment } from "postcss";

dotenv.config();


const userSchema = new mongoose.Schema({
    userId: Number,
    postCount: Number,
  });

let postsSchema = new mongoose.Schema({
  id: {type: Number},
    userid: {type: Number},
    content: {type: String},
})

const commentSchema = new mongoose.Schema({
  id: Number,
  postid: Number,
  content: String
});
 

const app = express();

app.use(express.json());
app.use(
  cors({
    origin: "http://localhost:5173", 
    methods: ["GET", "POST", "PUT", "DELETE"],
    credentials: true,
  })
);


app.get('/users',(req, res)=> {
  const topUsers = userSchema.sort((a,b)=> b.postCount -a.postCount).slice(0,5);
  res.json(topUsers)
});


app.get('/posts',(req, res)=> {
    let maximusComments = 0;
    const popularPosts = [];

    if(req.query.type === 'popular') {
        for(let post of postsSchema){
            if(post.comments.length > maximusComments){
                maximusComments = post.comments.length;
                popularPosts.push(post);
            }else if(post.comments.length === maximusComments){
                popularPosts.push(post);
            }
        }
        res.json(popularPosts);
    } else if(req.query.type === 'latest' ) {
     const latest = postsSchema.sort((a,b) => )
    }
})

app.get("/test/posts/:postid/comments", (req, res) => {
  const comments = commentSchema.find(req.params.postid);

  if (!comments) {
    return res.status(404).json({ message: "No comments" });
  }

  res.json(comments);
});


app.get("/", (req, res) => {
  res.send("Welcome to the API!");
});


const PORT = process.env.PORT || 5001;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
